<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Estaci√≥n Meteorol√≥gica</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(to bottom, #e0f7fa, #f1f8ff);
      color: #333;
    }

    header {
      background: #00bcd4;
      color: white;
      padding: 1.5rem;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    main {
      max-width: 1000px;
      margin: auto;
      padding: 1rem;
    }

    .grafico-container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 1.5rem;
      margin: 1.5rem auto;
    }

    h2 {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      color: #00bcd4;
      text-align: center;
    }

    .valor-actual {
      text-align: center;
      font-size: 1.3rem;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }

    canvas {
      width: 100% !important;
      max-height: 340px;
      height: auto !important;
    }

    .brujulas {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
    }

    .brujulas div {
      text-align: center;
      margin: 10px;
    }

    .brujulas canvas {
      margin-bottom: 10px;
    }

    @media (max-width: 600px) {
      .brujulas {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>

<header>
  <h1>üì° Estaci√≥n Meteorol√≥gica</h1>
</header>

<main>
  <div class="grafico-container">
    <h2>üå°Ô∏è Temperatura (¬∞C)</h2>
    <div class="valor-actual" id="valorTemp">--</div>
    <canvas id="graficoTemp"></canvas>
  </div>

  <div class="grafico-container">
    <h2>üíß Humedad (%)</h2>
    <div class="valor-actual" id="valorHum">--</div>
    <canvas id="graficoHum"></canvas>
  </div>

  <div class="grafico-container">
    <h2>üìè Presi√≥n (hPa)</h2>
    <div class="valor-actual" id="valorPres">--</div>
    <canvas id="graficoPres"></canvas>
  </div>

  <div class="grafico-container">
    <h2>üå¨Ô∏è Direcci√≥n y Velocidad del Viento</h2>
    <div class="brujulas">
      <div>
        <canvas id="brujulaApi" width="150" height="150"></canvas>
        <div class="valor-actual" id="valorApiDir">--</div>
        <div class="valor-actual" id="valorApiVel">Velocidad: -- km/h</div>
      </div>
      <div>
        <canvas id="brujulaEstacion" width="150" height="150"></canvas>
        <div class="valor-actual" id="valorEstacionDir">--</div>
        <div class="valor-actual" id="valorEstacionVel">Velocidad: -- km/h</div>
      </div>
    </div>
  </div>
</main>

<script>
  const channelID = 2991138;
  const readAPIKey = "CQCKW0T4ORH6UR3H";
  const openWeatherAPI = "9ee5d7e13cf00cdb7b2696791348f6af";
  const ciudad = "Buenos Aires";
  const updateInterval = 60000; // 1 min

  // Configuraci√≥n de gr√°ficos con dos datasets
  const ctxTemp = document.getElementById('graficoTemp').getContext('2d');
  const ctxHum = document.getElementById('graficoHum').getContext('2d');
  const ctxPres = document.getElementById('graficoPres').getContext('2d');

  const graficoTemp = new Chart(ctxTemp, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label: 'Estaci√≥n', data: [], borderColor: '#ff5722', fill: false },
        { label: 'API', data: [], borderColor: '#2196f3', borderDash: [5, 5], fill: false }
      ]
    },
    options: { responsive: true, scales: { x: { display: true }, y: { beginAtZero: false } } }
  });

  const graficoHum = new Chart(ctxHum, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label: 'Estaci√≥n', data: [], borderColor: '#03a9f4', fill: false },
        { label: 'API', data: [], borderColor: '#9c27b0', borderDash: [5, 5], fill: false }
      ]
    },
    options: { responsive: true, scales: { x: { display: true }, y: { beginAtZero: false } } }
  });

  const graficoPres = new Chart(ctxPres, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label: 'Estaci√≥n', data: [], borderColor: '#4caf50', fill: false },
        { label: 'API', data: [], borderColor: '#ff9800', borderDash: [5, 5], fill: false }
      ]
    },
    options: { responsive: true, scales: { x: { display: true }, y: { beginAtZero: false } } }
  });

  function gradosACardinal(grados) {
    const direcciones = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSO","SO","OSO","O","ONO","NO","NNO"];
    let idx = Math.round(grados / 22.5) % 16;
    return direcciones[idx];
  }

  function dibujarBrujula(ctx, angulo, color) {
    ctx.clearRect(0, 0, 150, 150);
    ctx.beginPath();
    ctx.arc(75, 75, 70, 0, 2 * Math.PI);
    ctx.strokeStyle = "#00bcd4";
    ctx.lineWidth = 4;
    ctx.stroke();

    ctx.font = "12px Arial";
    ctx.fillStyle = "#333";
    ctx.fillText("N", 70, 15);
    ctx.fillText("S", 70, 145);
    ctx.fillText("E", 135, 80);
    ctx.fillText("O", 10, 80);

    ctx.save();
    ctx.translate(75, 75);
    ctx.rotate((angulo * Math.PI) / 180);
    ctx.beginPath();
    ctx.moveTo(0, -50);
    ctx.lineTo(0, 10);
    ctx.strokeStyle = color;
    ctx.lineWidth = 4;
    ctx.stroke();
    ctx.restore();
  }

  let ctxApi = document.getElementById('brujulaApi').getContext('2d');
  let ctxEst = document.getElementById('brujulaEstacion').getContext('2d');

  function actualizarBrujulas(apiDir, apiVel, estDir, estVel) {
    dibujarBrujula(ctxApi, apiDir, "blue");
    dibujarBrujula(ctxEst, estDir, "green");

    document.getElementById('valorApiDir').innerText = gradosACardinal(apiDir);
    document.getElementById('valorEstacionDir').innerText = gradosACardinal(estDir);

    document.getElementById('valorApiVel').innerText = "Velocidad: " + apiVel.toFixed(1) + " km/h";
    document.getElementById('valorEstacionVel').innerText = "Velocidad: " + estVel.toFixed(1) + " km/h";
  }

  async function actualizarDatos() {
    // Datos de la estaci√≥n (ThingSpeak)
    const resTS = await fetch(`https://api.thingspeak.com/channels/${channelID}/feeds.json?api_key=${readAPIKey}&results=10`);
    const dataTS = await resTS.json();

    const labels = dataTS.feeds.map(feed => new Date(feed.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
    const temps = dataTS.feeds.map(feed => parseFloat(feed.field1));
    const hums = dataTS.feeds.map(feed => parseFloat(feed.field3));
    const pres = dataTS.feeds.map(feed => parseFloat(feed.field2));

    graficoTemp.data.labels = labels;
    graficoTemp.data.datasets[0].data = temps;

    graficoHum.data.labels = labels;
    graficoHum.data.datasets[0].data = hums;

    graficoPres.data.labels = labels;
    graficoPres.data.datasets[0].data = pres;

    document.getElementById('valorTemp').innerText = temps[temps.length - 1].toFixed(1) + " ¬∞C";
    document.getElementById('valorHum').innerText = hums[hums.length - 1].toFixed(1) + " %";
    document.getElementById('valorPres').innerText = pres[pres.length - 1].toFixed(1) + " hPa";

    let estDir = parseFloat(dataTS.feeds[dataTS.feeds.length - 1].field5) || 0;
    let estVel = parseFloat(dataTS.feeds[dataTS.feeds.length - 1].field6) || 0;

    // Datos de la API OpenWeather
    const resAPI = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${ciudad}&appid=${openWeatherAPI}&units=metric`);
    const dataAPI = await resAPI.json();
    let apiTemp = dataAPI.main.temp;
    let apiHum = dataAPI.main.humidity;
    let apiPres = dataAPI.main.pressure;
    let apiDir = dataAPI.wind.deg;
    let apiVel = dataAPI.wind.speed * 3.6;

    // Agregar la l√≠nea plana de API (repite el mismo valor)
    graficoTemp.data.datasets[1].data = Array(labels.length).fill(apiTemp);
    graficoHum.data.datasets[1].data = Array(labels.length).fill(apiHum);
    graficoPres.data.datasets[1].data = Array(labels.length).fill(apiPres);

    graficoTemp.update();
    graficoHum.update();
    graficoPres.update();

    actualizarBrujulas(apiDir, apiVel, estDir, estVel);
  }

  setInterval(actualizarDatos, updateInterval);
  actualizarDatos();
</script>


</body>
</html>

