<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Estaci√≥n Meteorol√≥gica</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(to bottom, #e0f7fa, #f1f8ff);
      color: #333;
    }

    header {
      background: #00bcd4;
      color: white;
      padding: 1.5rem;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    main {
      max-width: 1000px;
      margin: auto;
      padding: 1rem;
    }

    .grafico-container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 1.5rem;
      margin: 2rem auto;
    }

    h2 {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      color: #00bcd4;
      text-align: center;
    }

    .valor-actual {
      text-align: center;
      font-size: 1.3rem;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }

    canvas {
      width: 100% !important;
      max-height: 340px;
      height: auto !important;
    }

    @media (max-width: 600px) {
      header h1 {
        font-size: 1.3rem;
      }

      h2 {
        font-size: 1rem;
      }

      .grafico-container {
        padding: 1rem;
        margin: 1.5rem auto;
      }
    }
  </style>
</head>
<body>

  <header>
    <h1>üì° Estaci√≥n Meteorol√≥gica</h1>
  </header>

  <main>
    <div class="grafico-container">
      <h2>üå°Ô∏è Temperatura (¬∞C)</h2>
      <div class="valor-actual" id="valorTemp">--</div>
      <canvas id="graficoTemp"></canvas>
    </div>

    <div class="grafico-container">
      <h2>üíß Humedad (%)</h2>
      <div class="valor-actual" id="valorHum">--</div>
      <canvas id="graficoHum"></canvas>
    </div>

    <div class="grafico-container">
      <h2>üìè Presi√≥n (hPa)</h2>
      <div class="valor-actual" id="valorPres">--</div>
      <canvas id="graficoPres"></canvas>
    </div>

 
  </main>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const canalID = 2991138;
const apiKey = "CQCKW0T4ORH6UR3H";

const campos = [
  { id: 1, nombre: "Temperatura (¬∞C)", color: "#ff5252", canvasId: "graficoTemp" },
  { id: 3, nombre: "Humedad (%)", color: "#00aaff", canvasId: "graficoHum" },
  { id: 2, nombre: "Presi√≥n (hPa)", color: "#00cc66", canvasId: "graficoPres" },

];

let charts = {};

function cargarGraficos() {
  campos.forEach(campo => cargarPromediosHora(campo));
}

function cargarPromediosHora(campo) {
  const hoy = new Date();
  const inicio = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate(), 0, 0, 0);
  const fin = hoy;
  const formato = d => d.toISOString().split(".")[0] + "Z";

  const url = `https://api.thingspeak.com/channels/${canalID}/fields/${campo.id}.json?api_key=${apiKey}&start=${formato(inicio)}&end=${formato(fin)}&results=1000`;

  fetch(url)
    .then(res => res.json())
    .then(data => {
      const feeds = data.feeds;

      // Agrupar por hora
      const porHora = {};
      feeds.forEach(e => {
        const hora = new Date(e.created_at).getHours();
        const val = parseFloat(e[`field${campo.id}`]);
        if (!isNaN(val)) {
          if (!porHora[hora]) porHora[hora] = [];
          porHora[hora].push(val);
        }
      });

      const labels = [];
      const promedios = [];

      for (let h = 0; h <= hoy.getHours(); h++) {
        const datos = porHora[h] || [];
        if (datos.length) {
          const prom = datos.reduce((a, b) => a + b, 0) / datos.length;
          labels.push(h.toString().padStart(2, '0') + ":00");
          promedios.push(parseFloat(prom.toFixed(2)));
        }
      }

      // Mostrar √∫ltimo promedio arriba del gr√°fico
      const idValor = "valor" + campo.canvasId.replace("grafico", "");
      if (document.getElementById(idValor)) {
        document.getElementById(idValor).innerText = promedios[promedios.length - 1].toFixed(1);
      }

      renderizarGrafico(campo.canvasId, labels, [{
        label: campo.nombre + " (prom/h)",
        data: promedios,
        borderColor: campo.color,
        backgroundColor: campo.color + "33",
        fill: true,
        tension: 0.3,
        pointRadius: 3
      }], campo.nombre);
    })
    .catch(error => console.error("Error al cargar datos:", error));
}

function renderizarGrafico(canvasId, labels, datasets, titulo) {
  const ctx = document.getElementById(canvasId).getContext("2d");

  if (charts[canvasId]) {
    charts[canvasId].data.labels = labels;
    charts[canvasId].data.datasets = datasets;
    charts[canvasId].update();
  } else {
    charts[canvasId] = new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: datasets
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true },
          title: {
            display: true,
            text: titulo
          }
        },
        scales: {
          x: {
            title: { display: true, text: "Hora" },
            ticks: {
              maxTicksLimit: 24,
              autoSkip: false,
              maxRotation: 0,
              minRotation: 0
            }
          },
          y: {
            beginAtZero: false,
            title: { display: true, text: titulo }
          }
        }
      }
    });
  }
}

// Cargar ahora y cada 5 minutos
cargarGraficos();
setInterval(cargarGraficos, 5 * 60 * 1000);
</script>
</body>

</html>

